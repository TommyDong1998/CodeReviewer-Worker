packages:
  yum:
    git: []
    wget: []
    tar: []
    python3-pip: []
    gcc-c++: []
    make: []
    python3-devel: []

commands:
  01_configure_pip:
    command: |
      pip3 config set global.timeout 300
      pip3 config set global.retries 5

  02_install_semgrep:
    command: |
      set -e
      if semgrep --version 2>/dev/null; then
        echo "✓ Semgrep already installed: $(semgrep --version)"
        exit 0
      fi
      echo "Installing Semgrep..."
      pip3 install --no-cache-dir --ignore-installed requests semgrep==1.85.0 2>&1 || {
        echo "Initial install failed, attempting cleanup and retry..."
        pip3 uninstall -y semgrep 2>/dev/null || true
        pip3 install --no-cache-dir requests semgrep==1.85.0
      }
      echo "✓ Semgrep installed successfully: $(semgrep --version)"

  02b_install_opengrep:
    command: |
      set -e
      if opengrep --version 2>/dev/null; then
        echo "✓ OpenGrep already installed: $(opengrep --version)"
        exit 0
      fi
      echo "Installing OpenGrep..."
      ARCH=$(uname -m)

      if [ "$ARCH" = "x86_64" ]; then
        FILENAME="opengrep-core_linux_x86.tar.gz"
      elif [ "$ARCH" = "aarch64" ]; then
        FILENAME="opengrep-core_linux_aarch64.tar.gz"
      else
        echo "⚠ Unsupported architecture for OpenGrep: $ARCH. Skipping OpenGrep installation."
        exit 0
      fi

      BASE_URL="https://github.com/opengrep/opengrep/releases/latest/download"
      VERSIONED_URL="https://github.com/opengrep/opengrep/releases/download/v1.11.5"

      INSTALLED=false
      for URL in "$BASE_URL/$FILENAME" "$VERSIONED_URL/$FILENAME"; do
        echo "Trying: $URL"
        if curl -sSLf "$URL" -o opengrep.tar.gz 2>/dev/null; then
          tar -xzf opengrep.tar.gz
          BINARY=$(find . -name "opengrep" -type f | head -n1)
          if [ -n "$BINARY" ]; then
            mv "$BINARY" /usr/local/bin/opengrep
            chmod +x /usr/local/bin/opengrep
            rm -rf opengrep.tar.gz opengrep-core*
            echo "✓ OpenGrep installed successfully: $(opengrep --version)"
            INSTALLED=true
            break
          fi
          rm -rf opengrep.tar.gz opengrep-core*
        fi
      done

      if [ "$INSTALLED" = false ]; then
        echo "⚠ Could not install OpenGrep - no compatible release found for $ARCH. Continuing without OpenGrep."
        exit 0
      fi

  03_install_checkov:
    command: |
      set -e
      if checkov --version 2>/dev/null; then
        echo "✓ Checkov already installed: $(checkov --version | head -n1)"
        exit 0
      fi
      echo "Installing Checkov..."
      pip3 install --no-cache-dir checkov 2>&1 || {
        echo "Initial install failed, attempting cleanup and retry..."
        pip3 uninstall -y checkov 2>/dev/null || true
        pip3 install --no-cache-dir checkov
      }
      echo "✓ Checkov installed successfully: $(checkov --version | head -n1)"

  04_install_gitleaks:
    command: |
      set -e
      if gitleaks version 2>/dev/null; then
        echo "✓ Gitleaks already installed: $(gitleaks version)"
        exit 0
      fi
      echo "Installing Gitleaks..."
      ARCH=$(uname -m)
      if [ "$ARCH" = "x86_64" ]; then
        GITLEAKS_ARCH="linux_x64"
      elif [ "$ARCH" = "aarch64" ]; then
        GITLEAKS_ARCH="linux_arm64"
      else
        echo "Unsupported architecture for gitleaks: $ARCH" >&2
        exit 1
      fi
      curl -sSL "https://github.com/zricethezav/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_${GITLEAKS_ARCH}.tar.gz" | tar xz
      mv gitleaks /usr/local/bin/
      chmod +x /usr/local/bin/gitleaks
      echo "✓ Gitleaks installed successfully: $(gitleaks version)"

  05_install_trivy:
    command: |
      set -e
      if trivy --version 2>/dev/null; then
        echo "✓ Trivy already installed: $(trivy --version | head -n1)"
        exit 0
      fi
      echo "Installing Trivy..."
      ARCH=$(uname -m)
      if [ "$ARCH" = "x86_64" ]; then
        TRIVY_PACKAGE="trivy_0.48.3_Linux-64bit.tar.gz"
      elif [ "$ARCH" = "aarch64" ]; then
        TRIVY_PACKAGE="trivy_0.48.3_Linux-ARM64.tar.gz"
      else
        echo "Unsupported architecture for trivy: $ARCH" >&2
        exit 1
      fi
      wget -q "https://github.com/aquasecurity/trivy/releases/download/v0.48.3/${TRIVY_PACKAGE}"
      tar -xzf "${TRIVY_PACKAGE}"
      mv trivy /usr/local/bin/
      chmod +x /usr/local/bin/trivy
      rm -f "${TRIVY_PACKAGE}"
      echo "✓ Trivy installed successfully: $(trivy --version | head -n1)"
